<template>
  <div class="tenant-padding" :class="[`${prefixCls}`]">
    <div class="my-tenant">
      <span style="flex: 1">My Tenants</span>
      <span class="invited" @click="invitedClick">My Invitation Information<span class="approved-count" v-if="invitedCount>0">{{invitedCount}}</span></span>
    </div>
    <div class="tenant-list" v-if="dataSource.length>0">
      <div v-for="item in dataSource" class="tenant-list-item" @click="drownClick(item)">
        <div class="tenant-title">
          <div class="item-left">
            <div class="item-name">{{ item.name }}</div>
            <div class="item-house" @click.stop="copyClick(item.houseNumber)">
              <span>
                Organization house number: {{ item.houseNumber }}
                <Icon icon="ant-design:copy-outlined" style="font-size: 13px; margin-left: 2px" />
              </span>
            </div>
          </div>
          <div class="item-right">
            <span v-if="item.userTenantStatus === '3'">
              <span class="pointer examine">To be reviewed</span>
              <span class="pointer cancel-apply" @click.stop="cancelApplyClick(item.tenantUserId)">Cancel your application</span>
            </span>
            <span v-else-if="item.userTenantStatus === '5'">
              <span class="pointer examine" @click="joinOrRefuseClick(item.tenantUserId,'1')">JOIN</span>
              <span class="pointer cancel-apply" @click.stop="joinOrRefuseClick(item.tenantUserId,'4')">REFUSE</span>
            </span>
            <div v-else style="width: 75px"></div>
            <span style="margin-left: 24px">
              <Icon v-if="item.show" icon="ant-design:down-outlined" style="font-size: 13px; color: #707070" />
              <Icon v-else icon="ant-design:right-outlined" style="font-size: 13px; color: #707070" />
            </span>
          </div>
        </div>
        <div class="item-content" v-show="item.show">
          <div class="content-box">
            <div class="content-name"> Organize business cards </div>
            <div class="content-desc">
              <div class="flex-flow">
                <div class="content-des-text">Name</div>
                <div style="font-size: 13px;color: #000000">
                  {{ userDetail.realname }}
                </div>
              </div>
              <div class="flex-flow">
                <div class="content-des-text">Department</div>
                <div style="font-size: 13px">
                  {{ userDetail.orgCodeTxt ? userDetail.orgCodeTxt : 'Not filled' }}
                </div>
              </div>
              <div class="flex-flow">
                <div class="content-des-text">OCCUPATION</div>
                <div style="font-size: 13px">
                  {{ userDetail.postText ? userDetail.postText : 'Not filled' }}
                </div>
              </div>
            </div>
          </div>
          <div class="footer-box">
            <span
              v-if="item.userTenantStatus !== '3'"
              @click.stop="footerClick('editTenant', item)"
              class="font-color333 flex-flow margin-right40 font-size13 pointer"
            >
              <Icon icon="ant-design:edit-outlined" class="footer-icon" />
              <span>Review the tenant business card</span>
            </span>
            <span v-else class="font-color9e flex-flow margin-right40 font-size13">
              <Icon icon="ant-design:edit-outlined" class="footer-icon" />
              <span>Review the tenant business card</span>
            </span>
            <span
              v-if="item.userTenantStatus !== '3' && item.auth"
              @click.stop="footerClick('tenantSetting', item)"
              class="font-color333 flex-flow margin-right40 font-size13 pointer"
            >
              <Icon icon="ant-design:tool-outlined" class="footer-icon" />
              <span>Tenant management？</span>
            </span>
            <span v-else-if="item.userTenantStatus === '3' && item.auth" class="font-color9e flex-flow margin-right40 font-size13">
              <Icon icon="ant-design:tool-outlined" class="footer-icon" />
              <span>Tenant management？</span>
            </span>
            <span
              v-if="item.userTenantStatus !== '3' && !item.auth"
              @click.stop="footerClick('tenantSetting', item)"
              class="font-color333 flex-flow margin-right40 font-size13 pointer"
            >
              <Icon icon="ant-design:tool-outlined" class="footer-icon" />
              <span>Apply for role permissions？</span>
            </span>
            <span v-else-if="item.userTenantStatus === '3' && !item.auth" class="font-color9e flex-flow margin-right40 font-size13">
              <Icon icon="ant-design:tool-outlined" class="footer-icon" />
              <span>Apply for role permissions？</span>
            </span>
            <span
              v-if="item.userTenantStatus !== '3'"
              @click.stop="footerClick('tenantSetting', item)"
              class="font-color333 flex-flow margin-right40 font-size13 pointer"
            >
              <Icon icon="ant-design:gold-outlined" class="footer-icon" />
              <span>My reporting relationship？</span>
            </span>
            <span v-else class="font-color9e flex-flow margin-right40 font-size13">
              <Icon icon="ant-design:gold-outlined" class="footer-icon" />
              <span>My reporting relationship？</span>
            </span>
            <span
              v-if="item.userTenantStatus !== '3'"
              @click.stop="footerClick('exitTenant', item)"
              class="font-color333 flex-flow margin-right40 font-size13 pointer"
            >
              <Icon icon="ant-design:export-outlined" class="footer-icon" />
              <span>Exit the tenant</span>
            </span>
            <span v-else class="font-color9e flex-flow margin-right40 font-size13">
              <Icon icon="ant-design:export-outlined" class="footer-icon" />
              <span>Exit the tenant</span>
            </span>
          </div>
        </div>
      </div>
    </div>
    <a-empty v-else description="No data yet" style="position: relative;top: 50px;"/>
  </div>
  <a-modal v-model:visible="tenantVisible" width="400px" wrapClassName="edit-tenant-setting">
    <template #title>
      <div style="font-size: 17px; font-weight: 700">View business cards</div>
      <div style="color: #9e9e9e; margin-top: 10px; font-size: 13px"> A business card is your personal information under the organization and is only displayed in the organization. </div>
    </template>
    <div style="margin-top: 24px; font-size: 13px; padding: 0 24px">
      <div class="font-color75">Name</div>
      <div class="margin-top6 margin-bottom-16">{{ userDetail.realname }}</div>
      <div>Department</div>
      <div class="margin-top6 margin-bottom-16">{{ userDetail.orgCodeTxt ? userDetail.orgCodeTxt : 'Not filled' }}</div>
      <div>POSTS</div>
      <div class="margin-top6 margin-bottom-16">{{ userDetail.postText ? userDetail.postText : 'Not filled' }}</div>
      <div>Place of work</div>
      <div class="margin-top6 margin-bottom-16">{{ userData.workPlace ? userData.workPlace : 'Not filled' }}</div>
      <div>Construction No.</div>
      <div class="margin-top6 margin-bottom-16">{{ userDetail.workNo ? userDetail.workNo : 'Not filled' }}</div>
    </div>
  </a-modal>

  <!-- Exit the tenant -->
  <a-modal v-model:visible="cancelVisible" width="800" destroy-on-close>
    <template #title>
      <div class="cancellation">
        <Icon icon="ant-design:warning-outlined" style="font-size: 20px;color: red"/>
        Exit the tenant {{myTenantInfo.name}}
      </div>
    </template>
    <a-form :model="formCancelState" ref="cancelTenantRef">
      <a-form-item name="tenantName">
        <a-row :span="24" style="padding: 20px 20px 0;font-size: 13px">
          <a-col :span="24">
            Please enter a tenant name
          </a-col>
          <a-col :span="24" style="margin-top: 10px">
            <a-input v-model:value="formCancelState.tenantName" @change="tenantNameChange"/>
          </a-col>
        </a-row>
      </a-form-item>
      <a-form-item name="loginPassword">
        <a-row :span="24" style="padding: 0 20px;font-size: 13px">
          <a-col :span="24">
            Please enter your login password
          </a-col>
          <a-col :span="24" style="margin-top: 10px">
            <a-input-password v-model:value="formCancelState.loginPassword" />
          </a-col>
        </a-row>
      </a-form-item>
    </a-form>
    <template #footer>
      <a-button type="primary" @click="handleOutClick" :disabled="outBtnDisabled">Are you sure</a-button>
      <a-button @click="handleCancelOutClick">CANCEL</a-button>
    </template>
  </a-modal>

  <a-modal
    title="Change of Owner"
    v-model:visible="owenVisible"
    width="800"
    destroy-on-close
    :cancelButtonProps="{display:'none'}"
    @ok="changeOwen">
      <div style="padding: 20px">
        <a-row :span="24">
          <div class="change-owen">
            You can only exit after you have the change
          </div>
        </a-row>
        <a-row :span="24" style="margin-top: 10px">
          <UserSelect v-model:value="tenantOwen" izExcludeMy/>
        </a-row>
      </div>
  </a-modal>
  
  <!-- begin My invitation information -->
  <a-modal title="My Invitation Information" v-model:visible="invitedVisible" :footer="null">
      <a-row :span="24" class="invited-row">
        <a-col :span="16">
          Organization
        </a-col>
        <a-col :span="8">
          Operation
        </a-col>
      </a-row>
    <a-row :span="24" class="invited-row-list" v-for="item in invitedList">
      <a-col :span="16">
        {{item.name}}
      </a-col>
      <a-col :span="8">
        <span class="common" @click="joinOrRefuseClick(item.tenantUserId,'1')">Join</span>
        <span class="common refuse" @click="joinOrRefuseClick(item.tenantUserId,'4')">Refuse</span>
      </a-col>
    </a-row>
    <div style="height: 20px"></div>
  </a-modal>
  <!-- end My invitation information -->
</template>

<script lang="ts" name="tenant-setting" setup>
import { onMounted, ref, unref } from "vue";
import { getTenantListByUserId, cancelApplyTenant, exitUserTenant, changeOwenUserTenant, agreeOrRefuseJoinTenant } from "./UserSetting.api";
import { useUserStore } from "/@/store/modules/user";
import { CollapseContainer } from "/@/components/Container";
import { getFileAccessHttpUrl } from "/@/utils/common/compUtils";
import headerImg from "/@/assets/images/header.jpg";
import {useMessage} from "/@/hooks/web/useMessage";
import { initDictOptions } from '/@/utils/dict';
import { uniqWith } from 'lodash-es';
import { Modal } from 'ant-design-vue';
import UserSelect from '/@/components/Form/src/jeecg/components/userSelect/index.vue';
import {router} from "/@/router";
import { useDesign } from '/@/hooks/web/useDesign';

const { prefixCls } = useDesign('j-user-tenant-setting-container');
//数据源
const dataSource = ref<any>([]);
const userStore = useUserStore();

//数据源
const { createMessage } = useMessage();
//部门字典
const departOptions = ref<any>([]);
//租户编辑是或否隐藏
const tenantVisible = ref<boolean>(false);
//用户数据
const userData = ref<any>([]);
//用户
const userDetail = ref({
  realname: userStore.getUserInfo.realname,
  workNo: userStore.getUserInfo.workNo,
  orgCodeTxt: userStore.getUserInfo.orgCodeTxt,
  postText: userStore.getUserInfo.postText,
});
/**
 * 初始化租户数据
 */
  async function initDataSource() {
  //获取用户数据
    //update-begin---author:wangshuai ---date:20230109  for: [QQYUN-3645]个人设置我的租户查询审核中和正常的------------
    //update-begin---author:wangshuai ---date:202307049  for：[QQYUN-5608]用户导入后，邀请后,被导入人同意即可,新增被邀信息-----------
    getTenantListByUserId({ userTenantStatus: '1,3,5' }).then((res) => {
      if (res.success) {
        if(res.result && res.result.length>0){
          let result = res.result;
          //存放正常和审核中的数组
          let normal:any = [];
          //存放受邀的信息
          let invited:any = [];
          for (let i = 0; i < result.length; i++) {
            let status = result[i].userTenantStatus;
            //状态为邀请的放入invited数组中
            if(status === '5'){
              invited.push(result[i]);
            }
            normal.push(result[i]);
          }
          dataSource.value = normal;
          invitedList.value = invited;
          invitedCount.value = invited.length;
        }else{
          setInitedValue();
        }
      } else {
        setInitedValue();
    //update-end---author:wangshuai ---date:202307049  for：[QQYUN-5608]用户导入后，邀请后,被导入人同意即可,新增被邀信息------------
      }
    });
    //update-end---author:wangshuai ---date:20230109  for：[QQYUN-3645]个人设置我的租户查询审核中和正常的------------
  }
  function setInitedValue() {
    dataSource.value = [];
    invitedList.value = [];
    invitedCount.value = 0;  
  }

  /**
   * 复制门户
   * @param value
   */
  function copyClick(value) {
    // 创建input元素
    const el = document.createElement('input');
    // 给input元素赋值需要复制的文本
    el.setAttribute('value', value);
    // 将input元素插入页面
    document.body.appendChild(el);
    // 选中input元素的文本
    el.select();
    // 复制内容到剪贴板
    document.execCommand('copy');
    // 删除input元素
    document.body.removeChild(el);
    createMessage.success('The replication is successful');
  };

  /**
   * Cancel your application
   * @param id
   */
  function cancelApplyClick(id) {
    Modal.confirm({
      title: 'Cancel your application',
      content: 'Whether or not to cancel the application',
      okText: 'CONFIRM',
      cancelText: 'CANCEL',
      onOk: () => {
        cancelApplyTenant({ tenantId: id }).then((res) => {
          if (res.success) {
            createMessage.success('The cancellation application was successful');
            initDataSource();
          }else{
            createMessage.warning(res.message);
          }
        }).catch((e)=>{
           createMessage.warning(e.message);
        });
      },
    });
  };

  /**
   * Expand the closing event
   */
  function drownClick(value) {
    if (!value.show) {
      value.show = true;
    } else {
      value.show = false;
    }
  };

  /**
   * Get departmental text
   * @param value
   */
  function getDepartText(value) {
    let arr = departOptions.value.filter((item) => {
      item.value == value;
    });
    if (arr && arr.length > 0) {
      return arr[0].label;
    }
    return 'Not filled';
  };

  /**
   * Bottom text click events
   */
  function footerClick(type, item) {
    userData.value = item;
    //编辑组织名片
    if (type === 'editTenant') {
      tenantVisible.value = true;
    }else if(type === 'exitTenant'){
      //退出租户
      formCancelState.value = {loginPassword:'', tenantName:''};
      outBtnDisabled.value = true;
      cancelVisible.value = true;
      myTenantInfo.value = item;
    }
  }

  //退出租户弹窗
  const cancelVisible = ref<boolean>(false);
  //退出租户数据
  const formCancelState = ref<any>({});
  //租户数据
  const myTenantInfo = ref<any>({});
  //注销租户弹窗确定按钮是否可以点击
  const outBtnDisabled = ref<boolean>(true);
  //拥有者
  const tenantOwen = ref<string>('');
  //拥有者弹窗
  const owenVisible = ref<boolean>(false);

  /**
   * 租户名称值改变事件
   */
  function tenantNameChange() {
    let name = unref(myTenantInfo).name;
    let tenantName = unref(formCancelState).tenantName;
    if(name === tenantName){
      outBtnDisabled.value = false;
    }else{
      outBtnDisabled.value = true;
    }
  }

  /**
   * 退出确定点击事件
   */
  async function handleOutClick() {
    if(!unref(formCancelState).loginPassword){
        createMessage.warning("Please enter your login password");
        return;
    }
    console.log("myTenantInfo::::",myTenantInfo);
    await exitUserTenant({ id: unref(myTenantInfo).tenantUserId, loginPassword: unref(formCancelState).loginPassword }).then((res) => {
      if (res.success) {
        createMessage.success(res.message);
        cancelVisible.value = false;
        //update-begin---author:wangshuai ---date:20230703  for：【QQYUN-5632】退出租户后 再点击主页 已退出的租户应用还可以操作------------
        userStore.setTenant(null);
        //update-end---author:wangshuai ---date:20230703  for：【QQYUN-5632】退出租户后 再点击主页 已退出的租户应用还可以操作------------
        //切换租户后要刷新首页
        window.location.reload();
      } else {
        if (res.message === 'assignedOwen') {
          //需要指定变更者
          owenVisible.value = true;
          cancelVisible.value = false;
        //update-begin---author:wangshuai ---date:20230426  for：【QQYUN-5270】名下租户全部退出后，再次登录，提示租户全部冻结。拥有者提示前往注销------------
        }else if(res.message === 'cancelTenant'){
          cancelVisible.value = false;
          let fullPath = router.currentRoute.value.fullPath;
          Modal.confirm({
            title: 'You are the owner of the organization',
            content: 'There are no other members of the organization and you will need to go to cancel it',
            okText: 'Go to Sign out',
            okType: 'danger',
            cancelText: 'CANCEL',
            onOk: () => {
              if(fullPath === '/system/usersetting'){
                return;
              }
              router.push('/myapps/settings/organization/organMessage/'+unref(myTenantInfo).tenantUserId)
            }
          })
        //update-end---author:wangshuai ---date:20230426  for：【QQYUN-5270】名下租户全部退出后，再次登录，提示租户全部冻结。拥有者提示前往注销------------
        } else {
          createMessage.warning(res.message);
        }
      }
    }).catch((res) => {
      createMessage.warning(res.message);
    })
  }

  /**
   * Exit tenant cancellation event
   */
  function handleCancelOutClick() {
    cancelVisible.value = false;
    outBtnDisabled.value = true;
  }

  /**
   * Change possession
   */
  function changeOwen() {
    if(!unref(tenantOwen)){
      createMessage.warning("Please select Change Owner");
      return;
    }
    changeOwenUserTenant({ userId:unref(tenantOwen), tenantId:unref(myTenantInfo).tenantUserId }).then((res) =>{
      if(res.success){
        createMessage.success(res.message);
        userStore.setTenant(null);
        //After you switch tenants, refresh the home page
        window.location.reload();
      } else {
        createMessage.warning(res.message);
      }
    })
  }
  
  //Number of invitations
  const invitedCount = ref<number>(0);
  //Invitation information
  const invitedList = ref<any>([]);
  //Invitation information pop-up
  const invitedVisible = ref<boolean>(false);

  /**
   * Invited information click events
   */
  function invitedClick() {
    invitedVisible.value = true;
  }

  /**
   * Join an organization click event
   */
  async function joinOrRefuseClick(tenantId,status) {
    await agreeOrRefuseJoinTenant( { tenantId:Number.parseInt(tenantId), status:status });
    initDataSource();
  }
  
  onMounted(() => {
    initDataSource();
  });

</script>

<style lang="less" scoped>
.tenant-padding{
  padding: 30px 40px 0 20px;
}
.my-tenant{
  display: flex;
  font-size: 17px;
  font-weight: 700!important;
  /*begin 兼容暗夜模式*/
  color: @text-color;
  /*end 兼容暗夜模式*/
  margin-bottom: 20px;
  .invited{
    font-size: 14px;
    text-align: right;
    cursor: pointer;
  }
}
.tenant-list{
  box-sizing: border-box;
  flex: 1;
  min-height: 0;
  overflow-x: hidden;
}
.tenant-list-item{
  /*begin 兼容暗夜模式*/
  border: 1px solid @border-color-base;
  /*end 兼容暗夜模式*/
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  margin-bottom: 20px;
  overflow: hidden;
  padding: 0 25px;
  width: 100%;
  .item-name{
    align-items: center;
    box-sizing: border-box;
    display: flex;
    justify-content: space-between;
    padding: 14px 0;
    cursor: pointer;
    font-size:17px;
    /*begin 兼容暗夜模式*/
    color: @text-color;
    /*end 兼容暗夜模式*/
    font-weight: 700!important;
  }
}
.tenant-list-item:hover{
  box-shadow: 0 1px 2px 0 rgba(0,0,0,0.2);
}
.pointer {
  cursor: pointer;
}

.examine {
  color: #2c9cff;
  font-size: 13px;
}

.cancel-apply {
  margin-left: 24px;
  color: red;
  font-size: 13px;
}

.item-content {
  transition: ease-in 2s;

  .content-box {
    /*begin 兼容暗夜模式*/
    border-top: 1px solid @border-color-base;
    /*end 兼容暗夜模式*/
    box-sizing: border-box;
    display: flex;
    padding: 24px 0;
  }

  .content-name {
    /*begin 兼容暗夜模式*/
    color: @text-color;
    /*end 兼容暗夜模式*/
    text-align: center;
    width: 100px;
    font-size: 13px;
  }

  .content-desc {
    flex: 1;
    min-width: 0;
  }

  .content-des-text {
    /*begin 兼容暗夜模式*/
    color: @text-color;
    /*end 兼容暗夜模式*/
    text-align: left;
    width: 76px;
    font-size: 13px;
  }
}

.flex-flow {
  display: flex;
  min-width: 0;
}

.footer-box {
  /*begin Compatible with dark night mode*/
  border-top: 1px solid @border-color-base;
  /*end 兼容暗夜模式*/
  box-sizing: border-box;
  display: flex;
  padding: 24px 0;
  color: #757575;
}

.margin-right40 {
  margin-right: 40px;
}

/*begin Compatible with dark night mode*/
.font-color333 {
  color: @text-color;
  font-weight: normal;
}

.font-color9e {
  color: @text-color;
}

.font-color75 {
  color: @text-color;
}
/*end 兼容暗夜模式*/

.font-size13 {
  font-size: 13px;
}

.footer-icon {
  font-size: 13px !important;
  margin-right: 13px;
  position: relative;
  top: 4px;
}
:deep(.edit-tenant-setting) {
  color: #0a8fe9;
}
.margin-top6 {
  margin-top: 6px;
}
.margin-bottom-16 {
  margin-bottom: 16px;
}
.item-right {
  align-items: center;
  display: flex;
}
.tenant-title {
  align-items: center;
  box-sizing: border-box;
  display: flex;
  justify-content: space-between;
  padding: 24px 0;
}
.change-owen{
  font-size: 14px;
  font-weight: 700;
}
//update-begin---author:wangshuai ---date:20230704  for：Invited pop-up style------------
.approved-count{
  background: #ffd2d2;
  border-radius: 19px;
  color: red;
  display: inline-block;
  font-weight: 500;
  height: 19px;
  line-height: 18px;
  margin-left: 8px;
  min-width: 19px;
  padding: 0 6px;
  text-align: center;
}

.invited-row{
  padding: 10px 34px;
}
.invited-row-list{
  padding: 0px 34px;
  .common{
    color: #1e88e5;
    cursor: pointer;
  }
  .refuse{
    color: red;
    margin-left: 20px;
  }
}
.pointer{
  cursor: pointer;
}
//update-end---author:wangshuai ---date:20230704  for：被邀弹窗样式------------
</style>

<style lang="less">
  // update-begin-author:liusq date:20230625 for: [issues/563]暗色主题部分失效
@prefix-cls: ~'@{namespace}-j-user-tenant-setting-container';
/*begin Compatible with dark night mode*/
.@{prefix-cls} {

  .my-tenant{
    color: @text-color;
  }

  .tenant-list-item{
    border: 1px solid @border-color-base;

    .item-name{
      color: @text-color;
    }
  }

  .item-content {

    .content-box {
      border-top: 1px solid @border-color-base;
    }

    .content-name {
      color: @text-color;
    }

    .content-des-text {
      color: @text-color;
    }
  }
  .footer-box {
    border-top: 1px solid @border-color-base;
  }

  /*begin Compatible with dark night mode*/
  .font-color333 {
    color: @text-color;
  }

  .font-color9e {
    color: @text-color;
  }

  .font-color75 {
    color: @text-color;
  }
}
/*end Compatible with dark night mode*/
  // update-end-author:liusq date:20230625 for: [issues/563]暗色主题部分失效
</style>
